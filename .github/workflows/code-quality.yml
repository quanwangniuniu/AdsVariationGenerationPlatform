name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Python code quality
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort bandit mypy

      - name: Run flake8 linting
        run: |
          cd backend
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Run black formatting check
        run: |
          cd backend
          black --check --diff .

      - name: Run isort import sorting
        run: |
          cd backend
          isort --check-only --diff .

      - name: Run mypy type checking
        run: |
          cd backend
          mypy . --ignore-missing-imports || true

      - name: Run bandit security linting
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json || true
          bandit -r . -f txt

      - name: Upload Python quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-quality-reports
          path: |
            backend/bandit-report.json

  # Node.js code quality
  node-quality:
    name: Node.js Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint

      - name: Run Prettier check
        run: |
          cd frontend
          npx prettier --check .

      - name: Run TypeScript compilation
        run: |
          cd frontend
          npm run build

      - name: Run security audit
        run: |
          cd frontend
          npm audit --audit-level=moderate || true

      - name: Run dependency check
        run: |
          cd frontend
          npm outdated || true

  # Code coverage
  code-coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_USER: postgres
          POSTGRES_DB: test_mediajira_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install coverage pytest-cov

      - name: Install Node.js dependencies
        run: |
          cd frontend
          npm ci

      - name: Set up test environment
        run: |
          cd backend
          cp .env.example .env
          echo "DEBUG=True" >> .env
          echo "SECRET_KEY=test-secret-key-for-ci" >> .env
          echo "DB_HOST=localhost" >> .env
          echo "DB_PORT=5432" >> .env
          echo "DB_NAME=test_mediajira_db" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=postgres" >> .env
          echo "CELERY_BROKER_URL=redis://localhost:6379/0" >> .env
          echo "CELERY_RESULT_BACKEND=redis://localhost:6379/0" >> .env

      - name: Run database migrations
        run: |
          cd backend
          python manage.py migrate

      - name: Run Python tests with coverage
        run: |
          cd backend
          coverage run --source='.' manage.py test
          coverage report --show-missing
          coverage xml
          coverage html

      - name: Run Node.js tests with coverage
        run: |
          cd frontend
          npm run test:coverage || true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            backend/coverage.xml
            backend/htmlcov/
            frontend/coverage/

      - name: Upload to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: backend/coverage.xml
          flags: backend
          name: backend-coverage

  # Code complexity analysis
  complexity-analysis:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install analysis tools
        run: |
          cd backend
          pip install radon xenon
          cd ../frontend
          npm install -g complexity-report

      - name: Python complexity analysis
        run: |
          cd backend
          radon cc . -a -s
          radon mi . -s
          xenon . --max-absolute B --max-modules A --max-average A

      - name: Node.js complexity analysis
        run: |
          cd frontend
          complexity-report src/ --format json --output complexity-report.json || true
          complexity-report src/ --format text || true

      - name: Upload complexity reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-reports
          path: |
            frontend/complexity-report.json

  # Documentation quality
  documentation-quality:
    name: Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install documentation tools
        run: |
          cd backend
          pip install sphinx sphinx-autodoc-typehints

      - name: Check Python docstrings
        run: |
          cd backend
          python -c "
          import ast
          import os
          
          def check_docstrings(filepath):
              with open(filepath, 'r') as f:
                  tree = ast.parse(f.read())
              
              for node in ast.walk(tree):
                  if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                      if not ast.get_docstring(node):
                          print(f'Missing docstring in {filepath}:{node.lineno} - {node.name}')
          
          for root, dirs, files in os.walk('.'):
              for file in files:
                  if file.endswith('.py'):
                      check_docstrings(os.path.join(root, file))
          " || true

      - name: Check README quality
        run: |
          # Check if README exists and has content
          if [ -f "README.md" ]; then
            echo "README.md exists"
            word_count=$(wc -w < README.md)
            echo "README word count: $word_count"
            if [ $word_count -lt 100 ]; then
              echo "⚠️ README.md is too short"
            fi
          else
            echo "❌ README.md not found"
            exit 1
          fi

      - name: Check API documentation
        run: |
          # Check if API documentation exists
          if [ -f "openapi.yaml" ]; then
            echo "OpenAPI specification found"
          else
            echo "⚠️ OpenAPI specification not found"
          fi

  # Quality summary
  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [python-quality, node-quality, code-coverage, complexity-analysis, documentation-quality]
    if: always()
    steps:
      - name: Quality summary
        run: |
          echo "Code Quality Summary:"
          echo "===================="
          echo "Python Quality: ${{ needs.python-quality.result }}"
          echo "Node.js Quality: ${{ needs.node-quality.result }}"
          echo "Code Coverage: ${{ needs.code-coverage.result }}"
          echo "Complexity Analysis: ${{ needs.complexity-analysis.result }}"
          echo "Documentation Quality: ${{ needs.documentation-quality.result }}"
          
          # Check overall quality
          if [ "${{ needs.python-quality.result }}" == "success" ] && 
             [ "${{ needs.node-quality.result }}" == "success" ] && 
             [ "${{ needs.code-coverage.result }}" == "success" ] && 
             [ "${{ needs.complexity-analysis.result }}" == "success" ] && 
             [ "${{ needs.documentation-quality.result }}" == "success" ]; then
            echo "✅ All quality checks passed"
          else
            echo "⚠️ Some quality checks failed"
          fi

      - name: Notify quality status
        if: always()
        run: |
          if [ "${{ needs.quality-summary.result }}" == "success" ]; then
            echo "✅ Code quality checks passed"
            # Send success notification
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"✅ Code quality checks passed for commit ${{ github.sha }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || true
          else
            echo "❌ Code quality checks failed"
            # Send failure notification
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"❌ Code quality checks failed for commit ${{ github.sha }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || true
          fi
