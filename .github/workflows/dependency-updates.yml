name: Dependency Updates

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of dependency update to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - security
          - minor
          - major

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Check for updates
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      python-updates: ${{ steps.python-updates.outputs.updates }}
      node-updates: ${{ steps.node-updates.outputs.updates }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install Python dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-review

      - name: Install Node.js dependencies
        run: |
          cd frontend
          npm ci

      - name: Check Python updates
        id: python-updates
        run: |
          cd backend
          pip-review --local --auto --json > python-updates.json || true
          pip-review --local --auto
          
          # Check if there are updates
          if [ -f python-updates.json ]; then
            updates=$(jq '. | length' python-updates.json)
            echo "updates=$updates" >> $GITHUB_OUTPUT
          else
            echo "updates=0" >> $GITHUB_OUTPUT
          fi

      - name: Check Node.js updates
        id: node-updates
        run: |
          cd frontend
          npm install -g npm-check-updates
          ncu --json > node-updates.json || true
          ncu
          
          # Check if there are updates
          if [ -f node-updates.json ]; then
            updates=$(jq '. | length' node-updates.json)
            echo "updates=$updates" >> $GITHUB_OUTPUT
          else
            echo "updates=0" >> $GITHUB_OUTPUT
          fi

      - name: Upload update reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-updates
          path: |
            backend/python-updates.json
            frontend/node-updates.json

  # Security updates
  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'security' || github.event_name == 'schedule'
    needs: check-updates
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install safety
          cd ../frontend
          npm ci

      - name: Check Python security vulnerabilities
        run: |
          cd backend
          safety check --json --output safety-report.json || true
          safety check

      - name: Check Node.js security vulnerabilities
        run: |
          cd frontend
          npm audit --audit-level=moderate --json > npm-audit-report.json || true
          npm audit --audit-level=moderate

      - name: Create security update PR
        if: github.event_name == 'schedule'
        run: |
          # Create a new branch for security updates
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b security-updates-$(date +%Y%m%d)
          
          # Update Python security dependencies
          cd backend
          pip-review --local --auto || true
          
          # Update Node.js security dependencies
          cd ../frontend
          npm audit fix || true
          npm install
          
          # Commit changes
          git add .
          git commit -m "security: update dependencies with security fixes" || exit 0
          git push origin security-updates-$(date +%Y%m%d)
          
          # Create PR
          gh pr create --title "Security Updates $(date +%Y-%m-%d)" \
            --body "Automated security dependency updates for $(date +%Y-%m-%d)" \
            --base main \
            --head security-updates-$(date +%Y%m%d) || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-update-reports
          path: |
            backend/safety-report.json
            frontend/npm-audit-report.json

  # Minor updates
  minor-updates:
    name: Minor Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'minor' || github.event_name == 'schedule'
    needs: check-updates
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-review
          cd ../frontend
          npm ci
          npm install -g npm-check-updates

      - name: Update Python minor versions
        run: |
          cd backend
          pip-review --local --auto || true

      - name: Update Node.js minor versions
        run: |
          cd frontend
          ncu -u --target minor || true
          npm install

      - name: Create minor update PR
        if: github.event_name == 'schedule'
        run: |
          # Create a new branch for minor updates
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b minor-updates-$(date +%Y%m%d)
          
          # Commit changes
          git add .
          git commit -m "chore: update dependencies to latest minor versions" || exit 0
          git push origin minor-updates-$(date +%Y%m%d)
          
          # Create PR
          gh pr create --title "Minor Dependency Updates $(date +%Y-%m-%d)" \
            --body "Automated minor dependency updates for $(date +%Y-%m-%d)" \
            --base main \
            --head minor-updates-$(date +%Y%m%d) || true

  # Major updates
  major-updates:
    name: Major Updates
    runs-on: ubuntu-latest
    if: github.event.inputs.update_type == 'all' || github.event.inputs.update_type == 'major' || github.event_name == 'schedule'
    needs: check-updates
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pip-review
          cd ../frontend
          npm ci
          npm install -g npm-check-updates

      - name: Check for major Python updates
        run: |
          cd backend
          pip-review --local --auto --json > major-python-updates.json || true
          pip-review --local --auto

      - name: Check for major Node.js updates
        run: |
          cd frontend
          ncu --json > major-node-updates.json || true
          ncu

      - name: Create major update PR
        if: github.event_name == 'schedule'
        run: |
          # Create a new branch for major updates
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b major-updates-$(date +%Y%m%d)
          
          # Update Python major versions
          cd backend
          pip-review --local --auto || true
          
          # Update Node.js major versions
          cd ../frontend
          ncu -u || true
          npm install
          
          # Commit changes
          git add .
          git commit -m "chore: update dependencies to latest major versions" || exit 0
          git push origin major-updates-$(date +%Y%m%d)
          
          # Create PR
          gh pr create --title "Major Dependency Updates $(date +%Y-%m-%d)" \
            --body "Automated major dependency updates for $(date +%Y-%m-%d)" \
            --base main \
            --head major-updates-$(date +%Y%m%d) || true

      - name: Upload major update reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: major-update-reports
          path: |
            backend/major-python-updates.json
            frontend/major-node-updates.json

  # Update summary
  update-summary:
    name: Update Summary
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates, minor-updates, major-updates]
    if: always()
    steps:
      - name: Update summary
        run: |
          echo "Dependency Update Summary:"
          echo "========================="
          echo "Python Updates Available: ${{ needs.check-updates.outputs.python-updates }}"
          echo "Node.js Updates Available: ${{ needs.check-updates.outputs.node-updates }}"
          echo "Security Updates: ${{ needs.security-updates.result }}"
          echo "Minor Updates: ${{ needs.minor-updates.result }}"
          echo "Major Updates: ${{ needs.major-updates.result }}"
          
          # Check if updates are available
          if [ "${{ needs.check-updates.outputs.python-updates }}" -gt 0 ] || [ "${{ needs.check-updates.outputs.node-updates }}" -gt 0 ]; then
            echo "ðŸ“¦ Dependency updates are available"
          else
            echo "âœ… All dependencies are up to date"
          fi

      - name: Notify update status
        if: always()
        run: |
          if [ "${{ needs.check-updates.outputs.python-updates }}" -gt 0 ] || [ "${{ needs.check-updates.outputs.node-updates }}" -gt 0 ]; then
            echo "ðŸ“¦ Dependency updates available"
            # Send notification about available updates
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ðŸ“¦ Dependency updates available: Python (${{ needs.check-updates.outputs.python-updates }}), Node.js (${{ needs.check-updates.outputs.node-updates }})"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || true
          else
            echo "âœ… All dependencies are up to date"
            # Send success notification
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"âœ… All dependencies are up to date"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || true
          fi
